<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Jornada - Firma Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
      max-width: 600px;
      margin: auto;
    }
    h2 { color: #1a73e8; }
    label { margin-top: 10px; display: block; }
    select, button, canvas {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    #resumen {
      margin-top: 20px;
      padding: 10px;
      background: #e0f7fa;
      border: 1px solid #81d4fa;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }
    #firmaCanvas {
      border: 1px solid #ccc;
      height: 150px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <h2>Registro de Jornada</h2>
  <form id="formulario">
    <label for="nombre">Empleado:</label>
    <select id="nombre" required>
      <option value="">Selecciona tu nombre</option>
      <option value="Carlos">Carlos</option>
      <option value="Janet">Janet</option>
      <option value="Victor">Victor</option>
    </select>

    <label for="tipo">Tipo de jornada:</label>
    <select id="tipo" required>
      <option value="">Selecciona una opción</option>
      <option value="Entrada">Entrada</option>
      <option value="Almuerzo">Almuerzo</option>
      <option value="Salida">Salida</option>
    </select>

    <label for="firma">Firma digital:</label>
    <canvas id="firmaCanvas"></canvas>
    <button type="button" onclick="limpiarFirma()">Limpiar firma</button>

    <input type="hidden" id="fecha">
    <input type="hidden" id="hora">
    <input type="hidden" id="firmaBase64">

    <button type="submit">Registrar</button>
  </form>

  <div id="resumen"></div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script>
    const canvas = document.getElementById('firmaCanvas');
    const signaturePad = new SignaturePad(canvas);
    function limpiarFirma() {
      signaturePad.clear();
    }

    const form = document.getElementById('formulario');
    const resumen = document.getElementById('resumen');
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzHMwc5tQOJFBXvZFDfz9dxg7eko9OXBalY1puXJVH8zR1nF9yi8Y21awl8RvWOgr4EHg/exec'; // ← reemplaza con tu Google Apps Script

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value;
      const tipo = document.getElementById('tipo').value;
      const fecha = new Date().toISOString().split('T')[0];
      const hora = new Date().toLocaleTimeString();

      // Verifica duplicado en localStorage
      const clave = `${nombre}_${fecha}_${tipo}`;
      if (localStorage.getItem(clave)) {
        alert(`Ya registraste tu ${tipo.toLowerCase()} hoy.`);
        return;
      }

      // Verifica firma
      if (signaturePad.isEmpty()) {
        alert("Por favor, firma antes de registrar.");
        return;
      }

      const firmaDataURL = signaturePad.toDataURL();
      document.getElementById('firmaBase64').value = firmaDataURL;

      // Obtener ubicación
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta GPS.");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(4);
        const lon = pos.coords.longitude.toFixed(4);
        const gps = `${lat},${lon}`;

        const datos = new URLSearchParams({
          Nombre: nombre,
          TipoJornada: tipo,
          Fecha: fecha,
          Hora: hora,
          GPS: gps,
          Firma: firmaDataURL
        });

        fetch(scriptURL, { method: 'POST', body: datos })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              localStorage.setItem(clave, hora);
              resumen.innerHTML = `
                ✅ <strong>Registro exitoso</strong><br>
                <b>Empleado:</b> ${nombre}<br>
                <b>${tipo}:</b> ${hora}<br>
                <b>Ubicación:</b> ${gps}<br>
                <hr><b>Resumen del día:</b><br>${data.resumen}
              `;
              form.reset();
              signaturePad.clear();
            } else {
              alert("Error: " + data.message);
            }
          });
      }, () => {
        alert("No se pudo obtener la ubicación.");
      });
    });
  </script>

</body>
</html>
