<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Coastal VA Marine Construction Hours</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f3f6f9;
            padding: 30px;
            max-width: 600px;
            margin: auto;
        }

        h1 {
            text-align: center;
            color: #01487d;
            margin-bottom: 20px;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .empleado-group {
            margin-top: 15px;
            font-weight: 600;
        }

        .empleado-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .empleado-option input[type="checkbox"] {
            margin-right: 8px;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
        }

        select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        video {
            width: 100%;
            max-height: 180px;
            margin-top: 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #captureBtn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        #captureBtn:hover {
            background-color: #45a049;
        }

        #resumen {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f4f1;
            border-left: 5px solid #34a853;
            border-radius: 6px;
        }

        #fotoCanvas {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Coastal VA Marine Construction Hours</h1>

    <form id="registroForm">
        <div class="empleado-group">
            Empleado(s):
            <div class="empleado-option">
                <input type="checkbox" id="carlos" name="empleado" value="Carlos">
                <label for="carlos">Carlos</label>
            </div>
            <div class="empleado-option">
                <input type="checkbox" id="janet" name="empleado" value="Janet">
                <label for="janet">Janet</label>
            </div>
            <div class="empleado-option">
                <input type="checkbox" id="victor" name="empleado" value="Victor">
                <label for="victor">Victor</label>
            </div>
        </div>

        <label for="tipo">Tipo de jornada:</label>
        <select id="tipo" required>
            <option value="">Selecciona una opci√≥n</option>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
        </select>

        <label for="video">Vista de la c√°mara:</label>
        <video id="video" autoplay></video>
        <button type="button" id="captureBtn">Capturar Foto</button>
        <canvas id="fotoCanvas"></canvas>
        <input type="hidden" id="fotoBase64">

        <button type="submit">Registrar</button>
    </form>

    <div id="resumen"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('fotoCanvas');
        const context = canvas.getContext('2d');
        const captureBtn = document.getElementById('captureBtn');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyn--DNaur-r1Nld13BpQYicMetgEFXm5kJ2EvP7T-HHO0ky8lmbOrK7NobJvB6g3DItQ/exec'; // üîÅ Reemplaza con tu URL de Google Apps Script
        let fotoTomada = false;

        // Activar c√°mara trasera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => video.srcObject = stream)
            .catch(() => alert("No se pudo acceder a la c√°mara trasera."));

        captureBtn.addEventListener('click', function() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            document.getElementById('fotoBase64').value = canvas.toDataURL("image/jpeg");
            fotoTomada = true;
            alert("Foto capturada. Ahora puedes registrar.");
        });

        document.getElementById('registroForm').addEventListener('submit', function (e) {
            e.preventDefault();

            if (!fotoTomada) {
                alert("Por favor, captura una foto antes de registrar.");
                return;
            }

            const empleadosSeleccionados = Array.from(document.querySelectorAll('input[name="empleado"]:checked'))
                .map(checkbox => checkbox.value);

            if (empleadosSeleccionados.length === 0) {
                alert("Por favor, selecciona al menos un empleado.");
                return;
            }

            const tipo = document.getElementById('tipo').value;
            const fecha = new Date().toISOString().split('T')[0];
            const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }); // 24h
            const fotoBase64 = document.getElementById('fotoBase64').value;

            // Capturar ubicaci√≥n
            navigator.geolocation.getCurrentPosition(pos => {
                const gps = `${pos.coords.latitude.toFixed(4)},${pos.coords.longitude.toFixed(4)}`;

                empleadosSeleccionados.forEach(nombre => {
                    const clave = `${nombre}_${fecha}_${tipo}`;

                    if (localStorage.getItem(clave)) {
                        alert(`${nombre} ya registr√≥ su ${tipo.toLowerCase()} hoy.`);
                        return; // Skip to the next employee if already registered
                    }

                    const datos = new URLSearchParams({
                        Nombre: nombre,
                        TipoJornada: tipo,
                        Fecha: fecha,
                        Hora: hora,
                        GPS: gps,
                        Foto: fotoBase64
                    });

                    fetch(scriptURL, { method: 'POST', body: datos })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                localStorage.setItem(clave, hora);
                                document.getElementById('resumen').innerHTML += `
                                    ‚úÖ <strong>Registro exitoso para ${nombre}</strong><br>
                                    <b>Jornada:</b> ${tipo}<br>
                                    <b>Hora:</b> ${hora}<br>
                                    <b>Ubicaci√≥n:</b> ${gps}<br><br>
                                `;
                            } else {
                                alert(`Error al registrar a ${nombre}: ` + data.message);
                            }
                        });
                });

                // Clear the form and reset the fotoTomada flag
                document.getElementById('registroForm').reset();
                fotoTomada = false;
                document.getElementById('fotoBase64').value = ""; // Clear the base64 data
                document.getElementById('resumen').innerHTML = ""; // Clear previous resumen

                // Fetch and display the day's resumen
                fetch(scriptURL + "?resumen_hoy=true&fecha=" + fecha) // Example: Adjust your Apps Script to handle this
                    .then(res => res.json())
                    .then(data => {
                        if (data.resumen_general) {
                            document.getElementById('resumen').innerHTML += `<br><b>Resumen del d√≠a:</b><br>${data.resumen_general}`;
                        }
                    });

            }, () => alert("No se pudo obtener la ubicaci√≥n."));
        });
    </script>

</body>
</html>
