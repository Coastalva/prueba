<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Jornada con Foto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f2f5;
      max-width: 600px;
      margin: auto;
    }
    video, canvas {
      width: 100%;
      max-height: 200px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    #resumen {
      margin-top: 20px;
      background: #e0f7fa;
      padding: 10px;
      border-radius: 5px;
    }
    button {
      margin-top: 10px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Registro de Jornada</h2>

  <form id="formulario">
    <label for="nombre">Empleado:</label>
    <select id="nombre" required>
      <option value="">Selecciona tu nombre</option>
      <option value="Carlos">Carlos</option>
      <option value="Janet">Janet</option>
      <option value="Victor">Victor</option>
    </select>

    <label for="tipo">Tipo de jornada:</label>
    <select id="tipo" required>
      <option value="">Selecciona una opción</option>
      <option value="Entrada">Entrada</option>
      <option value="Almuerzo">Almuerzo</option>
      <option value="Salida">Salida</option>
    </select>

    <video id="video" autoplay></video>
    <canvas id="fotoCanvas" style="display:none;"></canvas>
    <input type="hidden" id="fotoBase64">

    <button type="submit">Registrar</button>
  </form>

  <div id="resumen"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('fotoCanvas');
    const context = canvas.getContext('2d');
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwtEISKOzotEBN4qXhiKoygYbokiTuMNkfgXWS0qeLSjZuVlMICml8szjcMYWqqy07HPA/exec'; // ← pega tu URL del Apps Script

    // Activar cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("No se pudo acceder a la cámara: " + err));

    // Registrar formulario
    document.getElementById('formulario').addEventListener('submit', function (e) {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value;
      const tipo = document.getElementById('tipo').value;
      const fecha = new Date().toISOString().split('T')[0];
      const hora = new Date().toLocaleTimeString();
      const clave = `${nombre}_${fecha}_${tipo}`;

      if (localStorage.getItem(clave)) {
        alert(`Ya registraste tu ${tipo.toLowerCase()} hoy.`);
        return;
      }

      // Tomar foto
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const fotoBase64 = canvas.toDataURL("image/jpeg");

      // Obtener ubicación
      navigator.geolocation.getCurrentPosition(pos => {
        const gps = `${pos.coords.latitude.toFixed(4)},${pos.coords.longitude.toFixed(4)}`;

        const datos = new URLSearchParams({
          Nombre: nombre,
          TipoJornada: tipo,
          Fecha: fecha,
          Hora: hora,
          GPS: gps,
          Foto: fotoBase64
        });

        fetch(scriptURL, { method: 'POST', body: datos })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              localStorage.setItem(clave, hora);
              document.getElementById('resumen').innerHTML = `
                ✅ <strong>Registro exitoso</strong><br>
                <b>Empleado:</b> ${nombre}<br>
                <b>Jornada:</b> ${tipo}<br>
                <b>Hora:</b> ${hora}<br>
                <b>Ubicación:</b> ${gps}<br><br>
                <b>Resumen del día:</b><br>${data.resumen}
              `;
            } else {
              alert("Error: " + data.message);
            }
          });
      }, () => {
        alert("No se pudo obtener la ubicación.");
      });
    });
  </script>

</body>
</html>
