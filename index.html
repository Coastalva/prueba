<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Jornada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f2f5;
      max-width: 600px;
      margin: auto;
    }

    h2 {
      color: #1a73e8;
      text-align: center;
    }

    label {
      margin-top: 15px;
      display: block;
      font-weight: bold;
    }

    select, button, canvas {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
    }

    #firmaCanvas {
      border: 1px solid #ccc;
      height: 150px;
    }

    #resumen {
      margin-top: 20px;
      background: #e0f7fa;
      padding: 10px;
      border-radius: 5px;
    }

    button {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .limpiar {
      background-color: #ccc;
      color: black;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>Registro de Jornada</h2>

  <form id="formulario">
    <label for="nombre">Empleado:</label>
    <select id="nombre" required>
      <option value="">Selecciona tu nombre</option>
      <option value="Carlos">Carlos</option>
      <option value="Janet">Janet</option>
      <option value="Victor">Victor</option>
    </select>

    <label for="tipo">Tipo de jornada:</label>
    <select id="tipo" required>
      <option value="">Selecciona una opción</option>
      <option value="Entrada">Entrada</option>
      <option value="Almuerzo">Almuerzo</option>
      <option value="Salida">Salida</option>
    </select>

    <label for="firma">Firma digital:</label>
    <canvas id="firmaCanvas"></canvas>
    <button type="button" class="limpiar" onclick="limpiarFirma()">Limpiar firma</button>

    <input type="hidden" id="firmaBase64">
    <input type="hidden" id="fecha">
    <input type="hidden" id="hora">

    <button type="submit">Registrar</button>
  </form>

  <div id="resumen"></div>

  <!-- Firma Digital -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

  <script>
    const canvas = document.getElementById('firmaCanvas');
    const signaturePad = new SignaturePad(canvas);
    function limpiarFirma() {
      signaturePad.clear();
    }

    const form = document.getElementById('formulario');
    const resumen = document.getElementById('resumen');
    const scriptURL = 'https://script.google.com/macros/s/AKfycbz5cDh7_yuozDSugatNYDKKyQGflkofVAghzWugH-bw-s9wZq76BpLbjHywNYogY2Bqyw/exec'; // ← Reemplaza por tu URL de Google Apps Script

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const nombre = document.getElementById('nombre').value;
      const tipo = document.getElementById('tipo').value;
      const fecha = new Date().toISOString().split('T')[0];
      const hora = new Date().toLocaleTimeString();
      const clave = `${nombre}_${fecha}_${tipo}`;

      // Validar duplicado local
      if (localStorage.getItem(clave)) {
        alert(`Ya registraste tu ${tipo.toLowerCase()} hoy.`);
        return;
      }

      // Validar firma
      if (signaturePad.isEmpty()) {
        alert("Por favor, firma antes de enviar.");
        return;
      }

      const firmaBase64 = signaturePad.toDataURL();

      // Obtener GPS
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta GPS.");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const gps = `${pos.coords.latitude.toFixed(4)},${pos.coords.longitude.toFixed(4)}`;

        const datos = new URLSearchParams({
          Nombre: nombre,
          TipoJornada: tipo,
          Fecha: fecha,
          Hora: hora,
          GPS: gps,
          Firma: firmaBase64
        });

        fetch(scriptURL, {
          method: 'POST',
          body: datos
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            localStorage.setItem(clave, hora);
            resumen.innerHTML = `
              ✅ <strong>Registro exitoso</strong><br>
              <b>Empleado:</b> ${nombre}<br>
              <b>Jornada:</b> ${tipo}<br>
              <b>Hora:</b> ${hora}<br>
              <b>Ubicación:</b> ${gps}<br><br>
              <b>Resumen del día:</b><br>${data.resumen}
            `;
            form.reset();
            signaturePad.clear();
          } else {
            alert("Error: " + data.message);
          }
        });

      }, () => {
        alert("No se pudo obtener tu ubicación.");
      });
    });
  </script>

</body>
</html>
